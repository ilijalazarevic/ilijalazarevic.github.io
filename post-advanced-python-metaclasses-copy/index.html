<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Ilija Lazarevic" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Ilija Lazarevic" /> <title> Advanced Python: Metaclasses - Ilija Lazarevic </title> <link rel="alternate" href="http://localhost:4000/post-advanced-python-metaclasses-copy/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/post-advanced-python-metaclasses-copy/" /> <meta name="description" content="Metaclasses in Python are advanced concepts, but let&#39;s see if we can unpack the complexity." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Advanced Python: Metaclasses | Ilija Lazarevic" /> <meta property="og:title" content="Advanced Python: Metaclasses | Ilija Lazarevic" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/post-advanced-python-metaclasses-copy/" /> <meta property="og:description" content="Metaclasses in Python are advanced concepts, but let&#39;s see if we can unpack the complexity." /> <meta property="og:image" content="http://localhost:4000/assets/img/timeleviathan_locked_up_inside_you.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Advanced Python: Metaclasses | " /> <meta name="twitter:url" content="http://localhost:4000/post-advanced-python-metaclasses-copy/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="Metaclasses in Python are advanced concepts, but let&#39;s see if we can unpack the complexity." /> <meta name="twitter:image" content="http://localhost:4000/assets/img/timeleviathan_locked_up_inside_you.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ilija Lazarevic" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- for mathjax support --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#python">PYTHON</a>, <a class="tag" href="/tags/#oop">OOP</a>, <a class="tag" href="/tags/#advanced">ADVANCED</a> </span> </div> <h1 class="header-title" itemprop="headline">Advanced Python: Metaclasses</h1> <div class="post-meta"> <time datetime="2023-09-06T07:14:21+02:00" itemprop="datePublished"> Sep 06, 2023 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Ilija Lazarevic</span> </span> <time hidden datetime="2023-09-06T07:14:21+02:00" itemprop="dateModified"> Sep 06, 2023 </time> <span hidden itemprop="publisher" itemtype="Person">Ilija Lazarevic</span> <span hidden itemprop="image">../assets/img/timeleviathan_locked_up_inside_you.png</span> <span hidden itemprop="mainEntityOfPage"><p>This article is purposefully going to be a bit advanced and there is at least two reasons.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>This article is purposefully going to be a bit advanced and there is at least two reasons.</p> <p>For one, the basic intros are already available everywhere, and it is a path walked a million times. For the reader who is trying to get things done in Python that will be more than enough.</p> <p>For two, more advanced talks about OOP mostly go in the direction of describing encapsulation, abstraction, inheritance and polymorphism, and how to use them in numerous design patterns guided by some of the principles in software engineering (for example <em>SOLID</em>).</p> <p>Now, my idea is to briefly write about how Python enables OOP paradigm. In essence, what is behind these lines of code:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Person</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">Child</span><span class="p">()</span>
</code></pre></div></div> <p>Back in the days when you learned about object-oriented programming, you most probably came across a general idea that describes what classes and objects are, and it goes like this:</p> <blockquote> <blockquote> <p>“Class is like a cookie mold. And objects are cookies molded by it”.</p> </blockquote> </blockquote> <p>This is a very intuitive explanation and conveys the idea rather clearly. Having said that, our example defines two templates with little or no functionalities, but they work. You can play with defining the <code class="language-plaintext highlighter-rouge">__init__</code> method, set some object attributes, and make it more usable. However, what is interesting <strong>in Python</strong> is that <strong>even though a class is a “template” that is used to create objects from it, it is also an object itself.</strong> Everyone learning OOP in Python would quickly go over this statement, not really thinking in depth. Everything in Python is an object, so what? But once you start thinking about this, a lot of questions pop up, and interesting Python intricacies unravel.</p> <p>Before I start asking these questions for you, let’s remember that <strong>in Python, everything is an object</strong>. And I mean everything. This is probably something you already picked up, even if you are a newbie. The next example shows this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="nb">id</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span> 
<span class="c1"># some memory location
</span>
<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Person</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="nb">id</span><span class="p">(</span><span class="n">Child</span><span class="p">)</span>
<span class="c1"># some memory location
</span>
<span class="c1"># Class objects are created, you can instantiate objects
</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Child</span><span class="p">()</span>
<span class="nb">id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="c1"># some memory location
</span></code></pre></div></div> <p>Based on these examples, here are some questions that you should ask yourself:</p> <ul> <li>If a class is an object, when is it created?</li> <li>Who creates class objects?</li> <li>If class is an object, how come I’m able to call it when instantiating an object?</li> </ul> <h2 id="class-object-creation"> <a href="#class-object-creation" class="anchor-head"></a> Class object creation </h2> <p>Python is widely known as an interpreted language. This means there is an interpreter (program or process) that goes line by line and tries to translate it to machine code. This is opposed to compiled programming languages like C, where programming code is translated into machine code before you run it. This is a very simplified view. To be more precise, Python is both compiled and interpreted, but this is a subject for another time. What is important for our example is that the interpreter goes through the class definition, and once the class code block is finished, the class object is created. From then on, you are able to instantiate objects from it. You have to do this explicitly of course, even though class objects are instantiated implicitly.</p> <p>But what “process” is triggered when the interpreter finishes reading the class code block? We could go directly to details, but one chart speaks a thousand words:</p> <p><img src="../assets/img/chart_metaclass.png" alt="" /></p> <p>If you are not aware, Python has <code class="language-plaintext highlighter-rouge">type</code> functions that can be used for our purpose(s) now. By calling <code class="language-plaintext highlighter-rouge">type</code> with object as an argument, you will get object’s type. How ingenious! Take a look:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Person</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">Child</span><span class="p">()</span>

<span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="c1"># Child
</span>
<span class="nb">type</span><span class="p">(</span><span class="n">Child</span><span class="p">)</span>
<span class="c1"># type
</span></code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">type</code> call in the example makes sense. <code class="language-plaintext highlighter-rouge">c</code> is of type <code class="language-plaintext highlighter-rouge">Child</code>. We used a class (object) to create it. So in some way, you can think of <code class="language-plaintext highlighter-rouge">type(c)</code> giving you the name of its “creator”. And in a way, <code class="language-plaintext highlighter-rouge">Child</code> class is its creator because you called it to create a new instance. But what happens when you try to get the “creator” of the class object, <code class="language-plaintext highlighter-rouge">type(Child)</code>? You get <code class="language-plaintext highlighter-rouge">type</code>. To sum it up, <strong>object is an instance of a class, and a class is an instance of a type</strong>. By now you may be wondering how a class is an instance of a function, and the answer is: <code class="language-plaintext highlighter-rouge">type</code> is both a function and a class. This is intentionally left as it is because of backward compatibility back in the old days.</p> <p>What will make your head spin is the name we have for classes that are used to create class objects. It is <strong>metaclasses.</strong> And here it is important to make a distinction between inheritance from the perspective of the object-oriented paradigm and the mechanisms of a language that enable you to practice this paradigm. Metaclasses provide this mechanism. What can be even more confusing is that metaclasses are able to inherit parent classes just like regular ones can. But this can quickly become “inceptional” programming, so let’s not go that deep.</p> <p>Do we have to deal with these metaclasses on a daily basis? Well, no. In rare cases, you need to define and use them because, most of the time, default behavior is just fine.</p> <p>Let’s continue with our journey, this time with a new example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Parent</span><span class="p">(</span><span class="s">'John'</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
</code></pre></div></div> <p>Something like this should be your very first OOP step in Python. You are taught that <code class="language-plaintext highlighter-rouge">__init__</code> is a constructor, where you set the values of your object attributes, and you are good to go. However, this <code class="language-plaintext highlighter-rouge">__init__</code> dunder method is exactly what it says: the initialization step. Isn’t it strange that you call it to initialize an object, and yet you get an object instance in return? There is no <code class="language-plaintext highlighter-rouge">return</code> in this method. So, how is this possible? Who returns the instance of a class?</p> <p>Very few learn at the start of their Python journey that there is another method that is called implicitly and is named <code class="language-plaintext highlighter-rouge">__new__</code>. This method actually creates an instance before <code class="language-plaintext highlighter-rouge">__init__</code> is called to initialize it. Here is an example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'new is called'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'init is called'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Parent</span><span class="p">(</span><span class="s">'John'</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="c1"># new is called
# init is called
</span></code></pre></div></div> <p>What you’ll immediately see is that <code class="language-plaintext highlighter-rouge">__new__</code> returns <code class="language-plaintext highlighter-rouge">super().__new__(cls)</code>. This is a new instance. <code class="language-plaintext highlighter-rouge">super()</code> fetches the parent class of <code class="language-plaintext highlighter-rouge">Parent</code> which is implicitly <code class="language-plaintext highlighter-rouge">object</code> class. This class is inherited by all classes in Python. And is an object in itself too. Another innovative move by the Python creators!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
<span class="c1"># True
</span></code></pre></div></div> <p>But what binds <code class="language-plaintext highlighter-rouge">__new__</code> and <code class="language-plaintext highlighter-rouge">__init__</code>? There has to be something more to how object instantiation is performed when we call <code class="language-plaintext highlighter-rouge">Parent('John' ,35)</code>. Take a look at it once again. You are invoking (calling) a class object, like a function.</p> <h2 id="python-callable"> <a href="#python-callable" class="anchor-head"></a> Python callable </h2> <p>Python, being a structurally typed language, enables you to define specific methods in your class that describe a Protocol (a way of using its object), and based on this, all instances of a class will behave in the expected way. Do not get intimidated if you are coming from other programming languages. Protocols are something like Interfaces in other languages. However, here we do not explicitly state that we are implementing a specific interface and, therefore, specific behavior. We just implement methods that are described by Protocol, and all objects are going to have that behavior. One of these Protocols is <em>Callable</em>. By implementing dunder method <code class="language-plaintext highlighter-rouge">__call__</code> you enable your object to be called like a function. See the example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'new is called'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'init is called'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Parent here!'</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Parent</span><span class="p">(</span><span class="s">'John'</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">p</span><span class="p">()</span>
<span class="c1"># Parent here!
</span></code></pre></div></div> <p>By implementing <code class="language-plaintext highlighter-rouge">__call__</code> in the class definition, your class instances become <em>callable</em>. But what about <code class="language-plaintext highlighter-rouge">Parent('John', 35)</code>. How do you achieve the same with your class object? If object’s type definition (class) specifies that it is callable, then the class object type (type i.e. metaclass) should specify that the class object is callable too, right? Invocation of the dunder methods <code class="language-plaintext highlighter-rouge">__new__</code> and <code class="language-plaintext highlighter-rouge">__init__</code> happens there.</p> <p>At this point, it is time to start playing with metaclasses.</p> <h2 id="python-metaclasses"> <a href="#python-metaclasses" class="anchor-head"></a> Python metaclasses </h2> <p>There are at least two ways you can change the process of class object creation. One is by using class decorators; the other is by explicitly specifying metalcass. We will describe the metaclass approach. Keep in mind that a metaclass looks like a regular class, and the only exception is that it has to inherit <code class="language-plaintext highlighter-rouge">type</code> class. Why? Because <code class="language-plaintext highlighter-rouge">type</code> class has all the implementation that is required for our code to still work as expected. For example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> is called'</span>
              <span class="sa">f</span><span class="s">' with args=</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s">, kwargs=</span><span class="si">{</span><span class="n">kwarg</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MyMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'new is called'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'init is called'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Parent</span><span class="p">(</span><span class="s">'John'</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="c1"># Parent is called with args=('John', 35), kwargs={}
</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="c1"># NoneType
</span></code></pre></div></div> <p>Here <code class="language-plaintext highlighter-rouge">MyMeta</code> is the drive force behind new class object instantiation and also specifies how new class instances are created. Take a closer look at the last two lines of the example. <code class="language-plaintext highlighter-rouge">p</code> holds nothing! But why? Because, as you can see, <code class="language-plaintext highlighter-rouge">MyMeta.__call__</code> just prints information and returns nothing. Explicitly, that is. Implicitly, that means that it returns <code class="language-plaintext highlighter-rouge">None</code>, which is of <code class="language-plaintext highlighter-rouge">NoneType</code>.</p> <p>How should we fix this?</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">cls</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> is called'</span>
              <span class="sa">f</span><span class="s">'with args=</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s">, kwargs=</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'metaclass calls __new__'</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'metaclass calls __init__'</span><span class="p">)</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span>

<span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MyMeta</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'new is called'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'init is called'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Parent</span><span class="p">(</span><span class="s">'John'</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="c1"># Parent is called with args=('John', 35), kwargs={}
# metaclass calls __new__
# new is called
# metaclass calls __init__
# init is called
</span>
<span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="c1"># Parent
</span>
<span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="c1"># '&lt;__main__.Parent object at 0x103d540a0&gt;'
</span></code></pre></div></div> <p>From the output, you can see what happens on <code class="language-plaintext highlighter-rouge">MyMeta.__call__</code>invocation. The provided implementation is just an example of how the whole thing works. You should be more careful if you plan to override parts of metaclasses yourself. There are some edge cases that you have to cover up. For example, one of the edge cases is that <code class="language-plaintext highlighter-rouge">Parent.__new__</code> can return an object that is not an instance of the <code class="language-plaintext highlighter-rouge">Parent</code> class. In that case, it is not going to be initialized by <code class="language-plaintext highlighter-rouge">Parent.__init__</code> method. That is the expected behavior you have to be aware of, and it really doesn’t make sense to initialize an object that is not an instance of the same class.</p> <p>Anyway, this would conclude the overview of what happens when you define a class and make an instance of it. Of course, you could go even further and see what happens during the class block interpretation. All of this happens in the metaclass too.</p> <p>Maybe I’ll write about it some time in the future. Until then, best of luck learning Python!</p> <h2 id="references"> <a href="#references" class="anchor-head"></a> References </h2> <ul> <li><a href="https://jfreeman.dev/blog/2020/12/07/python-metaclasses/">Python Metaclasses</a></li> <li><a href="https://www.honeybadger.io/blog/python-instantiation-metaclass/">Understanding Object Instantiation and Metaclasses in Python</a></li> </ul> <p>Here is one random Midjourney art for you persistent enough!</p> <p><img src="../assets/img/timeleviathan_locked_up_inside_you.png" /></p> </div> </article> </main> <small class="post-updated-at">updated_at 06-09-2023</small> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/post-advanced-python-functions/" > <div class="nav-arrow">Previous</div> <span class="post-title">Advanced Python: Functions</span> </a> </nav> <footer class="footer"> <span class="footer_item">Ilija Lazarevic &copy; 2023</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
